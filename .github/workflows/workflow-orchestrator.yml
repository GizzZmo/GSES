---
name: Workflow Orchestrator & File Generator

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - validate
          - generate
          - cleanup
  schedule:
    # Weekly orchestration check on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  # Check workflow status
  workflow-status:
    name: Workflow Status Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Analyze Workflow Files
        run: |
          echo "# Workflow Orchestrator Report - $(date)" > orchestrator-report.md
          echo "" >> orchestrator-report.md
          echo "## Workflow Inventory" >> orchestrator-report.md
          echo "" >> orchestrator-report.md
          
          # Count active workflows
          active_workflows=$(find .github/workflows -name "*.yml" | wc -l)
          disabled_workflows=$(find .github/workflows -name "*.disabled" | wc -l)
          
          echo "- **Active Workflows:** $active_workflows" >> orchestrator-report.md
          echo "- **Disabled Workflows:** $disabled_workflows" >> orchestrator-report.md
          echo "" >> orchestrator-report.md
          
          echo "### Active Workflows" >> orchestrator-report.md
          find .github/workflows -name "*.yml" -exec basename {} \; | sort | while read workflow; do
            echo "- $workflow" >> orchestrator-report.md
          done
          
          echo "" >> orchestrator-report.md
          echo "### Disabled Workflows" >> orchestrator-report.md
          find .github/workflows -name "*.disabled" -exec basename {} \; | sort | while read workflow; do
            echo "- $workflow" >> orchestrator-report.md
          done

      - name: Check Workflow Dependencies
        run: |
          echo "" >> orchestrator-report.md
          echo "## Workflow Dependencies" >> orchestrator-report.md
          echo "" >> orchestrator-report.md
          
          # Check for workflow_run dependencies
          echo "### Workflows with Dependencies" >> orchestrator-report.md
          grep -r "workflow_run:" .github/workflows/*.yml | while read line; do
            file=$(echo "$line" | cut -d: -f1)
            echo "- $(basename "$file")" >> orchestrator-report.md
          done || echo "No workflow dependencies found" >> orchestrator-report.md

      - name: Upload Orchestrator Report
        uses: actions/upload-artifact@v3
        with:
          name: orchestrator-report-${{ github.sha }}
          path: orchestrator-report.md
          retention-days: 30

  # Validate all workflows
  validate-workflows:
    name: Validate All Workflows
    runs-on: ubuntu-latest
    if: github.event.inputs.operation == 'validate' || github.event_name == 'schedule'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install YAML Validator
        run: |
          pip install pyyaml

      - name: Validate Active Workflows
        run: |
          echo "# Workflow Validation Report - $(date)" > validation-report.md
          echo "" >> validation-report.md
          echo "## Validation Results" >> validation-report.md
          echo "" >> validation-report.md
          
          valid_count=0
          total_count=0
          
          for workflow in .github/workflows/*.yml; do
            total_count=$((total_count + 1))
            if python3 -c "import yaml; yaml.safe_load(open('$workflow', 'r'))" 2>/dev/null; then
              valid_count=$((valid_count + 1))
              echo "- ✅ $(basename "$workflow")" >> validation-report.md
            else
              echo "- ❌ $(basename "$workflow")" >> validation-report.md
            fi
          done
          
          echo "" >> validation-report.md
          echo "**Summary:** $valid_count/$total_count workflows are valid" >> validation-report.md
          
          if [ "$valid_count" -eq "$total_count" ]; then
            echo "🎉 All workflows are valid!" >> validation-report.md
          else
            echo "⚠️ Some workflows need attention" >> validation-report.md
          fi

      - name: Upload Validation Report
        uses: actions/upload-artifact@v3
        with:
          name: validation-report-${{ github.sha }}
          path: validation-report.md
          retention-days: 30

  # Generate workflow files
  generate-workflows:
    name: Generate Workflow Templates
    runs-on: ubuntu-latest
    if: github.event.inputs.operation == 'generate'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Workflow Templates
        run: |
          mkdir -p workflow-templates
          
          # Basic CI template
          cat > workflow-templates/basic-ci-template.yml << 'EOF'
          ---
          name: Basic CI Template
          
          on:
            push:
              branches: [main]
            pull_request:
              branches: [main]
          
          jobs:
            basic-checks:
              name: Basic Checks
              runs-on: ubuntu-latest
              
              steps:
                - name: Checkout Code
                  uses: actions/checkout@v4
                  
                - name: Setup Environment
                  run: echo "Environment setup complete"
                  
                - name: Run Basic Tests
                  run: echo "Basic tests completed"
          EOF
          
          # Documentation template
          cat > workflow-templates/docs-template.yml << 'EOF'
          ---
          name: Documentation Template
          
          on:
            push:
              branches: [main]
              paths: ['**.md']
          
          jobs:
            docs-check:
              name: Documentation Check
              runs-on: ubuntu-latest
              
              steps:
                - name: Checkout Code
                  uses: actions/checkout@v4
                  
                - name: Check Documentation
                  run: echo "Documentation check completed"
          EOF
          
          echo "Generated workflow templates:"
          ls -la workflow-templates/

      - name: Upload Workflow Templates
        uses: actions/upload-artifact@v3
        with:
          name: workflow-templates-${{ github.sha }}
          path: workflow-templates/
          retention-days: 30

  # Cleanup operations
  cleanup-workflows:
    name: Cleanup Workflow Artifacts
    runs-on: ubuntu-latest
    if: github.event.inputs.operation == 'cleanup'

    steps:
      - name: Cleanup Old Artifacts
        uses: actions/github-script@v6
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < thirtyDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                  console.log(`Deleted artifact: ${artifact.name}`);
                } catch (error) {
                  console.log(`Failed to delete artifact ${artifact.name}: ${error.message}`);
                }
              }
            }
            
            console.log(`Cleanup complete. Deleted ${deletedCount} old artifacts.`);

  # Summary report
  orchestrator-summary:
    name: Orchestrator Summary
    runs-on: ubuntu-latest
    needs: [workflow-status, validate-workflows, generate-workflows, cleanup-workflows]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "# Workflow Orchestrator Summary - $(date)" > summary-report.md
          echo "" >> summary-report.md
          echo "## Job Results" >> summary-report.md
          echo "- Workflow Status: ${{ needs.workflow-status.result }}" >> summary-report.md
          echo "- Validation: ${{ needs.validate-workflows.result }}" >> summary-report.md
          echo "- Generation: ${{ needs.generate-workflows.result }}" >> summary-report.md
          echo "- Cleanup: ${{ needs.cleanup-workflows.result }}" >> summary-report.md
          echo "" >> summary-report.md
          
          # Count successful jobs
          success_count=0
          total_jobs=4
          
          [ "${{ needs.workflow-status.result }}" = "success" ] && success_count=$((success_count + 1))
          [ "${{ needs.validate-workflows.result }}" = "success" ] && success_count=$((success_count + 1))
          [ "${{ needs.generate-workflows.result }}" = "success" ] && success_count=$((success_count + 1))
          [ "${{ needs.cleanup-workflows.result }}" = "success" ] && success_count=$((success_count + 1))
          
          echo "**Success Rate:** $success_count/$total_jobs jobs completed successfully" >> summary-report.md
          
          if [ "$success_count" -eq "$total_jobs" ]; then
            echo "🎉 All orchestrator operations completed successfully!" >> summary-report.md
          else
            echo "⚠️ Some operations may need attention" >> summary-report.md
          fi

      - name: Upload Summary Report
        uses: actions/upload-artifact@v3
        with:
          name: orchestrator-summary-${{ github.sha }}
          path: summary-report.md
          retention-days: 30