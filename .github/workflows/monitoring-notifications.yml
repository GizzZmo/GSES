---
name: Monitoring & Notifications

on:
  workflow_run:
    workflows: ["CI and Deployment for Sui Move Project", "Minimal CI", "Code Quality & Linting"]
    types: [completed]
  schedule:
    # Daily health check at 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  # Monitor workflow health
  workflow-health-check:
    name: Workflow Health Monitor
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Workflow Status
        uses: actions/github-script@v6
        with:
          script: |
            const workflowRun = context.payload.workflow_run;
            
            if (workflowRun) {
              console.log(`Workflow: ${workflowRun.name}`);
              console.log(`Status: ${workflowRun.status}`);
              console.log(`Conclusion: ${workflowRun.conclusion}`);
              console.log(`URL: ${workflowRun.html_url}`);
              
              if (workflowRun.conclusion === 'failure') {
                console.log('⚠️ Workflow failed - monitoring for patterns');
              } else if (workflowRun.conclusion === 'success') {
                console.log('✅ Workflow completed successfully');
              }
            }

      - name: Generate Health Report
        run: |
          echo "# Workflow Health Report - $(date)" > health-report.md
          echo "" >> health-report.md
          echo "## System Status" >> health-report.md
          echo "- Repository: ${{ github.repository }}" >> health-report.md
          echo "- Branch: ${{ github.ref_name }}" >> health-report.md
          echo "- Last run: $(date)" >> health-report.md
          echo "" >> health-report.md
          echo "## Active Workflows" >> health-report.md
          find .github/workflows -name "*.yml" -exec basename {} \; | sort >> health-report.md

      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.sha }}
          path: health-report.md
          retention-days: 7

  # Check repository metrics
  repository-metrics:
    name: Repository Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Collect Repository Metrics
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              console.log('📊 Repository Metrics:');
              console.log(`- Stars: ${repo.stargazers_count}`);
              console.log(`- Forks: ${repo.forks_count}`);
              console.log(`- Open Issues: ${repo.open_issues_count}`);
              console.log(`- Size: ${repo.size} KB`);
              console.log(`- Language: ${repo.language}`);
              console.log(`- Last Updated: ${repo.updated_at}`);
              
              // Get recent activity
              const { data: commits } = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 10
              });
              
              console.log(`- Recent Commits: ${commits.length}`);
              console.log(`- Last Commit: ${commits[0]?.commit?.message || 'N/A'}`);
              
            } catch (error) {
              console.log('Error fetching metrics:', error.message);
            }

  # Notification handler
  send-notifications:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [workflow-health-check, repository-metrics]
    if: always()

    steps:
      - name: Prepare Notification Summary
        run: |
          echo "# Daily System Summary - $(date)" > notification-summary.md
          echo "" >> notification-summary.md
          echo "## Status Overview" >> notification-summary.md
          echo "- Workflow health check: ${{ needs.workflow-health-check.result }}" >> notification-summary.md
          echo "- Repository metrics: ${{ needs.repository-metrics.result }}" >> notification-summary.md
          echo "" >> notification-summary.md
          
          if [ "${{ needs.workflow-health-check.result }}" = "failure" ] || [ "${{ needs.repository-metrics.result }}" = "failure" ]; then
            echo "⚠️ Some monitoring checks failed - review required" >> notification-summary.md
          else
            echo "✅ All monitoring checks passed" >> notification-summary.md
          fi

      - name: Log Notification
        run: |
          echo "Notification summary generated:"
          cat notification-summary.md
          echo ""
          echo "In a production setup, this would send notifications to:"
          echo "- Slack/Discord channels"
          echo "- Email alerts"
          echo "- Dashboard updates"